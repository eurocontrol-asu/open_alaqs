import os
import sys

from PyQt4.QtCore import *
from PyQt4.QtGui import *
from qgis.core import *
from qgis.gui import *

import alaqs

# Add the tools directory to path
alaqs_interfaces_files = os.path.join(os.path.dirname(os.path.abspath(__file__)), "..", "tools")
if alaqs_interfaces_files not in sys.path:
    sys.path.append(alaqs_interfaces_files)

from tools.libALAQSMethod import roadway_emission_factors_alaqs_method

form = None
name_field = None
vehicle_year_field = None
speed_field = None
height_field = None
vehicle_light_field = None
vehicle_medium_field = None
vehicle_heavy_field = None
hour_profile_field = None
daily_profile_field = None
month_profile_field = None
co_gm_km_field = None
hc_gm_km_field = None
nox_gm_km_field = None
sox_gm_km_field = None
pm10_gm_km_field = None
p1_gm_km_field = None
p2_gm_km_field = None
method_field = None
scenario_field = None
instudy = None

def form_open(my_dialog, layer_id, feature_id):
    global form
    global name_field
    global vehicle_year_field
    global speed_field
    global height_field
    global vehicle_light_field
    global vehicle_medium_field
    global vehicle_heavy_field
    global hour_profile_field
    global daily_profile_field
    global month_profile_field
    global co_gm_km_field
    global hc_gm_km_field
    global nox_gm_km_field
    global sox_gm_km_field
    global pm10_gm_km_field
    global p1_gm_km_field
    global p2_gm_km_field
    global method_field
    global scenario_field
    global instudy

    form = my_dialog
    name_field = form.findChild(QLineEdit, "roadway_id")
    vehicle_year_field = form.findChild(QLineEdit, "vehicle_year")
    height_field = form.findChild(QLineEdit, "height")
    speed_field = form.findChild(QLineEdit, "speed")
    vehicle_light_field = form.findChild(QLineEdit, "vehicle_light")
    vehicle_medium_field = form.findChild(QLineEdit, "vehicle_medium")
    vehicle_heavy_field = form.findChild(QLineEdit, "vehicle_heavy")
    hour_profile_field = form.findChild(QComboBox, "hour_profile")
    daily_profile_field = form.findChild(QComboBox, "daily_profile")
    month_profile_field = form.findChild(QComboBox, "month_profile")
    co_gm_km_field = form.findChild(QLineEdit, "co_gm_km")
    hc_gm_km_field = form.findChild(QLineEdit, "hc_gm_km")
    nox_gm_km_field = form.findChild(QLineEdit, "nox_gm_km")
    sox_gm_km_field = form.findChild(QLineEdit, "sox_gm_km")
    pm10_gm_km_field = form.findChild(QLineEdit, "pm10_gm_km")
    p1_gm_km_field = form.findChild(QLineEdit, "p1_gm_km")
    p2_gm_km_field = form.findChild(QLineEdit, "p2_gm_km")
    scenario_field = form.findChild(QComboBox, "scenario")
    method_field = form.findChild(QLineEdit, "method")
    # ToDo:
    # method_field = form.findChild(QComboBox, "method")

    recalculate = form.findChild(QPushButton, "button_recalculate")
    button_box = form.findChild(QDialogButtonBox, "buttonBox")
    instudy = form.findChild(QCheckBox, "instudy")


    populate_combo_boxes()

    recalculate.clicked.connect(recalculate_emissions)
    #disconnect old-style signals, which are created e.g. by QGIS from the ui file
    try:
        QObject.disconnect(button_box, SIGNAL("accepted()"), form.accept)
    except Exception, e:
        pass
    #disconnect new-style signals
    try:
        button_box.accepted.disconnect(form.accept)
    except Exception, e:
        pass

    button_box.accepted.connect(validate)
    button_box.rejected.connect(form.reject)

    # Disable the travel distance field - this can come directly from the geometry
    QgsEditorWidgetWrapper.fromWidget( instudy ).setValue(1)
    QgsEditorWidgetWrapper.fromWidget( method_field ).setValue("ALAQS")
    QgsEditorWidgetWrapper.fromWidget( height_field ).setValue(0)
    # QgsEditorWidgetWrapper.fromWidget( scenario_field ).setValue('Not Applicable')

    # method_field.setText("ALAQS")
    # method_field.setEnabled(False)
    # scenario_field.setEnabled(False)
    # height_field.setText("0")
    # height_field.setEnabled(False)

def recalculate_emissions():
    try:
        # Do some validation first
        name = validate_field(name_field, "str")
        vehicle_year = validate_field(vehicle_year_field, "int")
        height = validate_field(height_field, "float")
        speed = validate_field(speed_field, "float")
        vehicle_light = validate_field(vehicle_light_field, "float")
        vehicle_medium = validate_field(vehicle_medium_field, "float")
        vehicle_heavy = validate_field(vehicle_heavy_field, "float")
        method = str(method_field.text())

        if name is False or vehicle_year is False or height is False or speed is False or vehicle_light is False or \
                        vehicle_medium is False or vehicle_heavy is False or method is False:
            msg_box = QMessageBox()
            msg_box.setText("Please complete all fields first")
            msg_box.exec_()
            return False
        
        vl = float(vehicle_light_field.text())
        vm = float(vehicle_medium_field.text())
        vh = float(vehicle_heavy_field.text())
        if (vl + vm + vh) != 100:
            msg_box = QMessageBox()
            msg_box.setText("Fleet mix must be decimal values that total 100%")
            msg_box.exec_()
            return False

        form_data_dict = dict()
        form_data_dict['name'] = name
        form_data_dict['vehicle_year'] = vehicle_year
        form_data_dict['height'] = height
        form_data_dict['speed'] = speed
        form_data_dict['vehicle_light'] = float(vehicle_light)
        form_data_dict['vehicle_medium'] = float(vehicle_medium)
        form_data_dict['vehicle_heavy'] = float(vehicle_heavy)
        form_data_dict['parking'] = False
        
        emission_profile = None
        if method == "ALAQS":
            # Calculate emissions according to the ALAQS method
            QApplication.setOverrideCursor(Qt.WaitCursor)
            emission_profile = roadway_emission_factors_alaqs_method(form_data_dict)
            print "Emission profile is %s"%emission_profile

            QApplication.restoreOverrideCursor()

        co_gm_km_field.setText(str(emission_profile['co_ef']))
        hc_gm_km_field.setText(str(emission_profile['hc_ef']))
        nox_gm_km_field.setText(str(emission_profile['nox_ef']))
        sox_gm_km_field.setText(str(emission_profile['sox_ef']))
        pm10_gm_km_field.setText(str(emission_profile['pm10_ef']))
        p1_gm_km_field.setText(str(emission_profile['p1_ef']))
        p2_gm_km_field.setText(str(emission_profile['p2_ef']))
    except Exception, e:
        msg_box = QMessageBox()
        msg_box.setText("Emissions could not be calculated: %s" % e)
        msg_box.exec_()


def populate_combo_boxes():
    """
    fills in the various comboboxes that are needed for the UI to be operational
    """
    hourly_profiles = alaqs.get_hourly_profiles()
    if (hourly_profiles is None) or (hourly_profiles == []):
        pass
    else:
        for profile in hourly_profiles:
            if profile[1] != "default":
                hour_profile_field.addItem(profile[1])
        hour_profile_field.setEditable(False)
        
    daily_profiles = alaqs.get_daily_profiles()
    if (daily_profiles is None) or (daily_profiles == []):
        pass
    else:
        for profile in daily_profiles:
            if profile[1] != "default":
                daily_profile_field.addItem(profile[1])
        daily_profile_field.setEditable(False)
    
    monthly_profiles = alaqs.get_daily_profiles()
    if (monthly_profiles is None) or (monthly_profiles == []):
        pass
    else:
        for profile in monthly_profiles:
            if profile[1] != "default":
                month_profile_field.addItem(profile[1])
        month_profile_field.setEditable(False)
    
    # lasport_scenarios = alaqs.get_lasport_scenarios()
    # if (lasport_scenarios is None) or (lasport_scenarios == []):
    #    pass
    # else:
    #    for scenario in lasport_scenarios:
    #        scenario = str(scenario[0]).replace("'", "")
    #        scenario_field.addItem(scenario)
    #    scenario_field.setEditable(False)
    # scenario_field.addItem("Not Applicable")

def validate():
    """
    This function validates that all of the required fields have been completed
    correctly. If they have, the attributes are committed to the feature. 
    Otherwise an error message is displayed and the incorrect field is 
    highlighted in red.
    """

    results = list()
    results.append(validate_field(name_field, "str"))
    results.append(validate_field(vehicle_year_field, "int"))
    results.append(validate_field(height_field, "float"))
    #results.append(validate_field(distance_field, "float"))
    results.append(validate_field(speed_field, "float"))
    results.append(validate_field(vehicle_light_field, "float"))
    results.append(validate_field(vehicle_medium_field, "float"))
    results.append(validate_field(vehicle_heavy_field, "float"))
    results.append(validate_field(hour_profile_field, "str"))
    results.append(validate_field(daily_profile_field, "str"))
    results.append(validate_field(month_profile_field, "str"))
    results.append(validate_field(co_gm_km_field, "float"))
    results.append(validate_field(hc_gm_km_field, "float"))
    results.append(validate_field(nox_gm_km_field, "float"))
    results.append(validate_field(sox_gm_km_field, "float"))
    results.append(validate_field(pm10_gm_km_field, "float"))
    results.append(validate_field(p1_gm_km_field, "float"))
    results.append(validate_field(p2_gm_km_field, "float"))

    for value in results:
        if value is False:
            msg_box = QMessageBox()
            msg_box.setText("Please complete all fields")
            msg_box.exec_()
            return False


    
    form.accept()


def validate_field(ui_element, var_type):
    try:
        if var_type is "str":
            try:
                value = str(ui_element.currentText()).strip()
            except:
                value = str(ui_element.text()).strip()
            if value is "":
                color_ui_background(ui_element, "red")
                ui_element.setToolTip("This value should be a string")
                return False
            else:
                color_ui_background(ui_element, "white")
                return value

        elif var_type is "int":
            try:
                value = str(ui_element.currentText()).strip()
            except:
                value = str(ui_element.text()).strip()
            try:
                if value == "" or value is None:
                    raise Exception()
                value = int(value)
                color_ui_background(ui_element, "white")
                return value
            except:
                color_ui_background(ui_element, "red")
                ui_element.setToolTip("This value should be an integer")
                return False

        elif var_type is "float":
            try:
                value = str(ui_element.currentText()).strip()
            except:
                value = str(ui_element.text()).strip()
            try:
                if value == "" or value is None:
                    raise Exception()
                value = float(value)
                color_ui_background(ui_element, "white")
                return value
            except:
                color_ui_background(ui_element, "red")
                ui_element.setToolTip("This value should be a float")
                return False
    except:
        return False


def color_ui_background(ui_element, color):
    if color is "red":
        ui_element.setStyleSheet("background-color: rgba(255, 107, 107, 150);")
    elif color is "white":
        ui_element.setStyleSheet("background-color: rgba(255, 255, 255, 255);")
    else:
        pass